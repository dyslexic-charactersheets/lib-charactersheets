unit: base/kingdom
name: "_{Kingdom}"
group: "_{Kingmaker}"

inc:
  - at: '@pages'
    add:

      - page: kingdom
        name: "_{Kingdom}"
        order: 10
        flex: true
        contents:
          - layout: 2l
            contents:
              - g:
                contents:
                  # - logo:

                  - section:
                    untitled: true
                    contents:
                      - class-icon: kingdom
                        optional: true
                        size: large
                        flex: huge
                      - class-name: "_{Kingdom}"
                      - field: kingdom-name
                        label: "_{Kingdom Name}"
                        width: stretch
                        align: left
                        border: full
                        size: large

                      - row:
                        contents:

                          - field: level
                            legend: "_{Kingdom Level}"
                            border: circle
                            format: int
                            size: huge
                          - field: size
                            legend: "_{Size}"
                            border: circle
                            format: int
                          - spacer:

                          - field: fame-infamy
                            legend: "_{Fame / Infamy}"
                            width: huge
                            border: full
                            control: compound
                            parts:
                              - field: fame
                                width: small
                              - vr:
                              - field: infamy
                                width: small

                          - spacer:

                          - field: xp
                            legend: "_{Kingdom XP}"
                            underlay: "_{XP}"
                            width: large
                            border: full
                            format: int
                         
                  - section: "_{Abilities}"
                    contents:

                      - p: "_{Ability Modifier = (Ability Score - 10) &divide; 2}"
                        align: left
                        optional: true

                      - table:
                        width: stretch
                        flip: true
                        rows:
                          - name: "_{Culture}"
                            short: "_{CUL}"
                            code: CUL
                            ruin: "_{Corruption}"
                            ruincode: corruption
                            absence-eq: "(%{leader-ruler-absent}?1:'')+(%{counselor-ruler-absent}?1:'')"
                          - name: "_{Economy}"
                            short: "_{ECO}"
                            code: ECO
                            ruin: "_{Crime}"
                            ruincode: crime
                            absence-eq: "(%{leader-ruler-absent}?1:'')+(%{treasurer-ruler-absent}?1:'')"
                          - name: "_{Loyalty}"
                            short: "_{LOY}"
                            code: LOY
                            ruin: "_{Loyalty}"
                            ruincode: loyalty
                            absence-eq: "(%{leader-ruler-absent}?1:'')+(%{emissary-ruler-absent}?1:'')"
                          - name: "_{Stability}"
                            short: "_{STA}"
                            code: STA
                            ruin: "_{Stability}"
                            ruincode: stability
                            absence-eq: "(%{leader-ruler-absent}?1:'')+(%{viceroy-ruler-absent}?1:'')"
                        columns:
                          # - h5: "_{Ability}"
                          #   rotate: true
                          - ""
                          - ""
                          - label: "_{Ruin\nPenalty}"
                          - label: "_{Absence\nPenalty}"
                          - label: "_{Unrest\nPenalty}"
                          - ""
                          - ""
                        template:
                          - g:
                            align: center
                            contents:
                              - field: "#{code}"
                                label: "#{name}"
                                control: ability
                                width: ""
                                parts:
                                  - subid: ""
                                    size: huge
                                    eq: "floor((minmax(%{#{code}-score},4,30)-10)/2)"
                                    width: ""
                                    format: modifier
                                  - subid: "score"
                                    width: ""
                                    format: int
                          - g:
                            align: center
                            contents:
                              - span: "&ndash;"
                          - g:
                            align: center
                            contents:
                              - field: "#{code}-ruin-penalty"
                                label: "#{ruin}"
                                ref: "#{ruincode}-penalty"
                          - g:
                            align: center
                            contents:
                              - field: "#{code}-absence-penalty"
                                eq: "#{absence-eq}"
                                ref: true
                          - g:
                            align: center
                            contents:
                              - field: "#{code}-unrest-penalty"
                                ref: "unrest-penalty"
                          - g:
                            align: center
                            contents:
                              - span: "&#8659;"
                          - g:
                            align: center
                            contents:
                              - field: "#{code}-penalty"
                                width: ""
                                border: full
                                eq: "%{#{code}}-%{#{code}-ruin-penalty}-%{#{code}-absence-penalty}-%{unrest-penalty}"

                  - section: "_{Ruin}"
                    contents:
                      - table:
                        columns:
                          - ""
                          - ""
                          - "_{Threshold}"
                          - ""
                          - "_{Penalty}"
                        rows:
                          - ruin: "_{Corruption}"
                            ruincode: corruption
                          - ruin: "_{Crime}"
                            ruincode: crime
                          - ruin: "_{Loyalty}"
                            ruincode: loyalty
                          - ruin: "_{Stability}"
                            ruincode: stability
                        template:
                          - field: "#{ruincode}"
                            legend: "#{ruin}"
                            border: full
                            width: large
                          - span: ">"
                          - field: "#{code}-threshold"
                            eq: "10"
                          - span: "&rarr;"
                          - field: "#{code}-penalty"
                            eq: ""
                          - span: "&#11189;"

                  - section: "_{Proficiency}"
                    contents:
                      - layout: 5e
                        gutter: none
                        flex: none
                        contents:
                          - field: proficiency-untrained
                            label: "_{Untrained}"
                            border: full
                            control: value
                            value: 0
                            icon: proficiency
                            ruby: "&nbsp;\n"
                          - field: proficiency-trained
                            label: "_{Trained}"
                            border: full
                            icon: proficiency-trained
                            ruby: "_{Level}\n+2"
                            eq: "minmax(%{level},1,20)+2"
                          - field: proficiency-expert
                            label: "_{Expert}"
                            border: full
                            icon: proficiency-expert
                            ruby: "_{Level}\n+4"
                            eq: "minmax(%{level},1,20)+4"
                          - field: proficiency-master
                            label: "_{Master}"
                            border: full
                            icon: proficiency-master
                            ruby: "_{Level}\n+6"
                            eq: "minmax(%{level},1,20)+6"
                          - field: proficiency-legendary
                            label: "_{Legendary}"
                            border: full
                            icon: proficiency-legendary
                            ruby: "_{Level}\n+8"
                            eq: "minmax(%{level},1,20)+8"
                      
                  - section: "_{Control}"
                    contents:
                      - calc:
                        output:
                          field: "control-dc"
                          legend: "_{Control DC}"
                          eq: "%{control-dc-base}+%{kingdom-size}+%{control-dc-misc}"
                          width: large
                        inputs:
                          - field: "control-dc-base"
                            label: "_{Base}"
                            eq: "threshold(%{level},[1,14,2,15,3,16,4,18,5,20,6,22,7,23,8,24,9,26,10,27,11,28,12,30,13,31,14,32,15,34,16,35,17,36,18,38,19,39,20,40])"
                          - span: "+"
                          - field: control-dc-kingdom
                            label: "_{Size Modifier}"
                            eq: "threshold(%{size},[1,0,10,1,25,2,50,3,100,4])"
                          - span: "+"
                          - field: control-dc-misc
                            label: "_{Vacancy Penalty}"
                            eq: "%{leader-ruler-absent}?2:''"
                            
                            # misc: true

                  - section: "_{Resources}"
                    contents:
                      - row:
                        contents:
                          - calc:
                            output:
                              field: resource-dice
                              legend: "_{Resource Dice}"
                              width: huge
                              border: full
                              control: compound
                              parts:
                                - subid: dice
                                  eq: "4+%{level}"
                                  align: right
                                - span: "_{d}"
                                - subid: die
                                  eq: "threshold(%{size},[1,4,10,6,25,8,50,10,100,12])"
                                  align: left
                            inputs:
                              - span: "4 +"
                              - field:
                                ref: level
                                label: "_{Kingdom Level}"
                          - spacer:
                          - span: "&rarr;"
                          - spacer:
                          - field: resource-points
                            legend: "_{Resource Points}"
                            suffix: "_{rp}"
                            border: full
                            width: huge

                      - row:
                        contents:
                          - calc:
                            output:
                              field: consumption
                              legend: "_{Consumption}"
                              width: huge
                              border: full
                              suffix: "_{rp}"
                            inputs:
                              - field: consumption-settlements
                                label: "_{Settlement Consumption}"
                              - span: "+"
                              - field: consumption-settlements
                                label: "_{Army Consumption}"
                              - span: "-"
                              - field: consumption-settlements
                                label: "_{Farmland Hexes}"
                                icon: hex
                              - span: "+"
                              - field: consumption-events
                                label: "_{Events}"
                                misc: true

                      - row:
                        contents:
                          - field: excess
                            legend: "_{Excess}"
                            width: huge
                            border: full
                            suffix: "_{rp}"
                            eq: "%{resource-points}-%{consumption}"
                          - p: "_{Excess resources become Kingdom XP}"
                          - spacer:

                    
                  - tail:
                  # - spacer:

              - g:
                contents:
                  - section: "_{Leaders}"
                    contents:
                      - list:
                        hr: true
                        # light: true
                        zebra: true
                        contents:

                          - each:
                            template:
                              - g:
                                contents:
                                  - row:
                                    contents:
                                      - field: "leader-#{code}"
                                        legend: "#{name}"
                                        width: stretch
                                        # size: large
                                      - field: "leader-#{code}-ability"
                                        label: "#{ability}"
                                        prefix: "+"
                                        eq: "%{leader-#{code}-absent} ? '' : threshold(%{level},[1,1,8,2,16,3])"
                                        border: full
                                  - field: "leader-#{code}-absent"
                                    frame: right
                                    control: checkbox
                                    label: "[b]_{Absent}[/b]: #{penalty}"
                            contents:
                              - name: "_{Ruler}"
                                code: ruler
                                ability: "_{Loyalty}"
                                penalty: "_{-1 to all checks; 1d4 unrest each turn; +2 control DC}"
                              - sort: name
                                contents:
                                  - name: "_{Counselor}"
                                    code: counselor
                                    ability: "_{Culture}"
                                    penalty: "_{-1 to Culture checks}"
                                  - name: "_{General}"
                                    code: general
                                    ability: "_{Stability}"
                                    penalty: "_{-4 to Warfare activities}"
                                  - name: "_{Emissary}"
                                    code: emissary
                                    ability: "_{Loyalty}"
                                    penalty: "_{-1 to Loyalty checks}"
                                  - name: "_{Magister}"
                                    code: magister
                                    ability: "_{Culture}"
                                    penalty: "_{-4 to Warfare activities}"
                                  - name: "_{Treasurer}"
                                    code: treasurer
                                    ability: "_{Treasurer}"
                                    penalty: "_{-1 to Economy checks}"
                                  - name: "_{Viceroy}"
                                    code: viceroy
                                    ability: "_{Economy}"
                                    penalty: "_{-1 to Stability checks}"
                                  - name: "_{Warden}"
                                    code: warden
                                    ability: "_{Stability}"
                                    penalty: "_{-4 to Region activities}"

                  - section: "_{Unrest}"
                    contents:
                      - row:
                        contents:
                          - field: unrest
                            legend: "_{Unrest}"
                            width: large
                            border: full
                          - span: "&rarr;"
                          - field: unrest-penalty
                            label: "_{Unrest Penalty}"
                            eq: "threshold(%{unrest},[0,0,1,-1,5,-2,10,-3,15,-4])"
                          - spacer:
                          - span: "1 &rarr; -1"
                          - spacer:
                          - span: "5 &rarr; -2"
                          - spacer:
                          - span: "10 &rarr; -3"
                          - spacer:
                          - span: "15 &rarr; -4"
                      - arrow: left
                        from: unrest
                        to: STA-unrest-penalty
                      # - arrow: left
                      #   from: leader-ruler-absent
                      #   to: STA-absence-penalty

                  - section: "_{Skills}"
                    contents:
                    
                      - table: skills
                        collapse: true
                        zebra: true
                        field_frame: none
                        width: stretch
                        columns:
                          -
                          - label: "_{Skill\nBonus}"
                            width: medium
                          -
                          - label: "_{Ability\nModifier}"
                            width: medium
                          - label: "_{Proficiency}"
                            width: medium
                          - label: "_{Feats Misc}"
                            width: small
                        rows:
                          - sort: name
                            # group: abilityref
                            # group_hr: true
                            contents:
                              - zone: '@skills'
                                contents:
                                  - skill: agriculture
                                    name: "_{Agriculture}"
                                    ability: "_{STA}"
                                    abilityref: STA
                                  - skill: arts
                                    name: "_{Arts}"
                                    ability: "_{CUL}"
                                    abilityref: CUL
                                  - skill: boating
                                    name: "_{Boating}"
                                    ability: "_{ECO}"
                                    abilityref: ECO
                                  - skill: defence
                                    name: "_{Defence}"
                                    ability: "_{STA}"
                                    abilityref: STA
                                  - skill: engineering
                                    name: "_{Engineering}"
                                    ability: "_{STA}"
                                    abilityref: STA
                                  - skill: exploration
                                    name: "_{Exploration}"
                                    ability: "_{ECO}"
                                    abilityref: ECO
                                  - skill: folklore
                                    name: "_{Folklore}"
                                    ability: "_{CUL}"
                                    abilityref: CUL
                                  - skill: industry
                                    name: "_{Industry}"
                                    ability: "_{ECO}"
                                    abilityref: ECO
                                  - skill: intrigue
                                    name: "_{Intrigue}"
                                    ability: "_{LOY}"
                                    abilityref: LOY
                                  - skill: magic
                                    name: "_{Magic}"
                                    ability: "_{CUL}"
                                    abilityref: CUL
                                  - skill: politics
                                    name: "_{Politics}"
                                    ability: "_{LOY}"
                                    abilityref: LOY
                                  - skill: scholarship
                                    name: "_{Scholarship}"
                                    ability: "_{CUL}"
                                    abilityref: CUL
                                  - skill: statecraft
                                    name: "_{Statecraft}"
                                    ability: "_{LOY}"
                                    abilityref: LOY
                                  - skill: trade
                                    name: "_{Trade}"
                                    ability: "_{ECO}"
                                    abilityref: ECO
                                  - skill: warfare
                                    name: "_{Warfare}"
                                    ability: "_{LOY}"
                                    abilityref: LOY
                                  - skill: wilderness
                                    name: "_{Wilderness}"
                                    ability: "_{STA}"
                                    abilityref: STA
                        template:
                          - row:
                            blk: false
                            contents:
                              - if: "#{name}=="
                                then:
                                  - nothing:
                                else:
                                  - h6: "#{name}"
                                    fade: "#{fade}"
                                    blk: false
                              - if: "#{blank}"
                                then:
                                  - field: "#{skill}-detail"
                                    frame: none
                                    width: stretch
                                    merge-bottom: true
                          - field: "#{skill}-bonus"
                            border: full
                            icon: bonus
                            width: medium
                            eq: '%{#{skill}-ability}+%{#{skill}-proficiency-bonus}+%{#{skill}-misc}-%{#{skill}-acp}'
                            format: modifier
                          - span: "="
                          - field: '#{skill}-ability'
                            ref: "#{abilityref}"
                            underlay: "#{ability}"
                            frame: h-label
                            label: "#{ability}"
                            width: medium
                          - field: "#{skill}-proficiency"
                            control: proficiency
                            width: medium
                          - field: "#{skill}-misc"
                            misc: true
                            width: medium
                            format: int

                  - tail:
                  - spacer:

      - page: feats
        name: "_{Feats}"
        order: 11
        flex: true
        contents:
          - layout: 2l
            contents:
              - g:
                contents:
                  - section: "_{Expansion Expert}"
                    contents:
                      - level: 4
                        contents:
                          - value-block: "+2"
                            content: "_{Claim Hex bonus twice per Kingdom turn}"

                      - level: 9
                        contents:
                          - value-block: "+2"
                            content: "_{Claim Hex bonus three times per Kingdom turn}"

                  - section: "_{Fine Living}"
                    contents:
                      - level: 4
                        contents:
                          - p: ""
                          
                      - level: 10
                        contents:
                          - h5: "_{Life of Luxury}"

                  - section: "_{Ruin Resistance}"
                    contents:
                      - level: 5


                  # - section: "_{Experienced Leadership}"
                  #   contents:
                  #     - level: 8
                  #       contents:
                  #         - value-block: "+2"
                  #           contents: "_{Claim Hex bonus twice per Kingdom turn}"

                  - section: "_{Civic Planning}"
                    contents:
                      - level: 12
                        contents:
                          - p: "_{Each Kingdom turn, one settlement can attempt two Civic activities.}"

                  - section: "_{Envy of the World}"
                    contents:
                      - level: 20
                        contents:
                          - p: ""

                  - tail:
                  - spacer:

              - g:
                contents:
                  - layout: 2e
                    contents:
                      - section: "_{Charter}"
                        contents:
                          - field: "kingdom:government"
                            width: stretch
                            label: "_{Charter}"
                          - spacer:

                      - section: "_{Government}"
                        contents:
                          - field: "kingdom:government"
                            width: stretch
                            label: "_{Government Type}"
                          - h5: "_{Government Feat}"
                          - article: "kingdom:government-bonus-feat"
                            lines: 6

                  - paste: class-feats
                    params:
                      id: kingdom-feats
                      title: "_{Kingdom Feats}"
                      lines: 6
                      
                  - tail:

      - page: settlements
        name: "_{Settlements & Armies}"
        order: 12
        flex: true
        contents:
          - layout: 2l
            contents:
              - g:
                contents:
                  - section: "_{Resources}"
                  - section: "_{Settlement Types}"
                    contents:
                      - table:
                        zebra: true
                        hr: true
                        flip: true
                        columns:
                          - ""
                          - ""
                          - "_{Population}"
                          - "_{Blocks}"
                          - "_{Settlement Level}"
                          - "_{Consumption}"
                          - "_{Max Item Bonus}"
                          - "_{Influence}"
                        rows:
                          - settlement: "_{Village}"
                            level: 1
                            population: "400"
                            blocks: 1
                            slevel: "1"
                            consumption: 1
                            itembonus: "+1"
                            influence: 0
                          - settlement: "_{Town}"
                            level: 3
                            population: "_{2,000}"
                            blocks: 4
                            slevel: "2-4"
                            consumption: 2
                            itembonus: "+1"
                            influence: "_{1 hex}"
                          - settlement: "_{City}"
                            level: 9
                            population: "_{25,000}"
                            blocks: 9
                            slevel: "5-9"
                            consumption: 4
                            itembonus: "+2"
                            influence: "_{2 hexes}"
                          - settlement: "_{Metropolis}"
                            level: 15
                            population: "_{25,000}+"
                            blocks: "10+"
                            slevel: "10+"
                            consumption: 6
                            itembonus: "+3"
                            influence: "_{3 hexes}"
                        template:
                          - level: "#{level}"
                          - p: "#{settlement}"
                          - p: "#{population}"
                          - span: "#{blocks}"
                          - span: "#{slevel}"
                          - span: "#{consumption}"
                          - span: "#{itembonus}"
                          - span: "#{influence}"

                  - section: "_{Farms}"
                    contents:
                      - p: ""

                  - tail:
                  - spacer:
              
              - g:
                contents:
                  - section: "_{Settlements}"
                    contents:
                      - list:
                        hr: true
                        zebra: true
                        contents:
                          - repeat: 10
                            contents:
                              - g:
                                contents:
                                  - row:
                                    contents:
                                      - field: "settlement-#{i}"
                                        frame: none
                                        size: large
                                        width: stretch
                                      - field: "settlement-#{i}-size"
                                        border: full
                                        label: "_{Size}"
                                        icon: hex
                                      - field: "settlement-#{i}-consumption"
                                        label: "_{Consumption}"
                                        suffix: "_{rp}"

                    
                  - section: "_{Armies}"
                    contents:
                      - list:
                        hr: true
                        contents:
                          - repeat: 6
                            contents:
                              - g:
                                contents:
                                  - field: "army-#{i}"
                                    frame: none
                                    width: stretch
                                  - field: "army-#{i}-size"
                                    border: full
                                  - field: "army-#{i}-consumption"
                                    label: "_{Consumption}"
                                    suffix: "_{rp}"

                  - tail:
                  - spacer:

      - page: level-up
        name: "_{Level Up}"
        order: 15
        flex: true
        contents:
          - layout: 2l
            contents:
              - g:
                contents:
                  - h2: "_{Level Up}"

                  - g:
                    pad: true
                    contents:
                      - h4: "_{Step One}"
                      - p: "_{}"
                      
                  - g:
                    pad: true
                    contents:
                      - h4: "_{Step Two}"
                      - p: "_{}"
                      
                  - g:
                    pad: true
                    contents:
                      - h4: "_{Step Three}"
                      - p: "_{}"
                      
                  - g:
                    pad: true
                    contents:
                      - h4: "_{Step Four}"
                      - p: "_{}"
                      
                  - g:
                    pad: true
                    contents:
                      - h4: "_{Step Five}"
                      - p: "_{}"

                  - tail:
                  - spacer:

              - g:
                contents:
                  - section: "_{Kingdom Advancement}"
                    contents:
                      - advancement: level-up
                        fields:
                          - zone: '@kingdom/advancement-fields'
                          - name: "_{Base\nControl DC}"
                            key: control-dc
                            format: string
                          - name: "_{Leadership\nbonus}"
                            key: leadership-bonus
                            format: string
                          - name: "_{Kingdom\nfeat}"
                            key: kingdom-feat
                          - name: "_{Skill\nincrease}"
                            key: skill-increase
                          - name: "_{Ruin\nresistance}"
                            key: ruin-resistance
                        advances:
                          - level: 1
                            gain: "_{Charter}"
                          - level: 1
                            gain: "_{Government}"
                          - level: 1
                            gain: "_{Heartland}"
                          - level: 1
                            gain: "_{Favoured land}"
                          - level: 3
                            gain: "_{Settle towns}"
                          - level: 9
                            gain: "_{Settle cities}"
                          - level: 15
                            gain: "_{Settle metropolises}"
                          - levels: [ 5, 10, 15, 20 ]
                            gain: "_{Ability boost} &times; 4"
                          - levels: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20 ]
                            control-dc: [ 14, 15, 16, 18, 19, 20, 22, 23, 24, 26, 27, 28, 30, 31, 32, 34, 35, 36, 38, 39, 40 ]
                          - levels: [ 1, 8, 16 ]
                            leadership-bonus: [ "+1", "+2", "+3" ]
                          - levels: [ 2, 4, 6, 8, 10, 12, 14, 16, 18, 20 ]
                            kingdom-feat: true
                          - levels: [ 1, 3, 5, 7, 9, 11, 13, 15, 17, 19 ]
                            skill-increase: true
                          - level: [ 5, 8, 11, 14, 17, 20 ]
                            ruin-resistance: true

                          # - zone: '@kingdom/advancement'

                  - tail:
                  - spacer:

      - page: reference
        name: "_{Kingdom Reference}"
        order: 20
        contents:
          - layout: 2e
            contents:
              - g:
                contents:
                
              - g:
                contents:
